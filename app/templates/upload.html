<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Extractor AI</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div id="password-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Password Required</h3>
            <p id="password-modal-message">This PDF is password-protected. Please enter the password to continue.</p>
            <form id="password-form">
                <input type="hidden" id="password-job-id" value="">
                <div class="form-group">
                    <label for="pdf-password">PDF Password:</label>
                    <input type="password" id="pdf-password" name="password" required>
                </div>
                <div id="password-error" class="error-message" style="display: none;"></div>
                <div class="modal-buttons">
                    <button type="submit" class="btn-submit">Submit</button>
                    <button type="button" class="btn-cancel" onclick="closePasswordModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div class="container">
        <h1>Invoice Extractor AI</h1>
        <p>Upload a PDF invoice to extract credit card transactions.</p>
        
        <div class="input-mode-toggle">
            <button type="button" id="btn-pdf-mode" class="mode-btn active" onclick="switchToMode('pdf')">Upload PDF</button>
            <button type="button" id="btn-text-mode" class="mode-btn" onclick="switchToMode('text')">Inserir texto extraído</button>
        </div>

        <form id="pdf-form" action="/upload" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label for="provider">LLM Provider:</label>
                <select id="provider" name="provider">
                    <option value="offline" selected>Offline (Local - Ollama)</option>
                    <option value="online">Online (OpenAI)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="file">Select PDF file:</label>
                <input type="file" id="file" name="file" accept=".pdf,application/pdf" required>
            </div>
            <button type="submit">Upload & Process</button>
        </form>

        <form id="text-form" action="/upload-text" method="post" style="display: none;">
            <div class="form-group">
                <label for="text-provider">LLM Provider:</label>
                <select id="text-provider" name="provider">
                    <option value="offline" selected>Offline (Local - Ollama)</option>
                    <option value="online">Online (OpenAI)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="extracted-text">Texto extraído da fatura:</label>
                <textarea id="extracted-text" style="width: 100%;" name="text" rows="15" placeholder="Cole aqui o texto já extraído da fatura de cartão de crédito..." required></textarea>
            </div>
            <button type="submit">Processar texto</button>
        </form>
    </div>

    <div class="queue-container" id="queue-container" style="{% if not jobs %}display:none;{% endif %}">
        <h2>Processing Queue</h2>
        <table class="queue-table">
            <thead>
                <tr>
                    <th></th>
                    <th>File</th>
                    <th>Uploaded</th>
                    <th>Finished at</th>
                    <th>Elapsed</th>
                    <th>Provider</th>
                    <th>Status</th>
                    <th>Progress</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="jobs-tbody">
                {% for job in jobs %}
                <tr data-job-id="{{ job.id }}" class="job-row">
                    <td class="chevron-cell" onclick="toggleDetails('{{ job.id }}')">
                        <span class="chevron" id="chevron-{{ job.id }}">&#9654;</span>
                    </td>
                    <td class="filename" title="{{ job.filename }}">{{ job.filename }}</td>
                    <td>{{ job.created_at }}</td>
                    <td>{{ job.finished_at if job.finished_at else "—" }}</td>
                    <td class="elapsed-cell" data-elapsed-seconds="{{ job.elapsed_seconds }}">{{ job.elapsed_time }}</td>
                    <td>
                        {% if job.provider == "offline" %}
                        <span class="provider-badge offline">{{ job.model_name }}</span>
                        {% else %}
                        <span class="provider-badge online">{{ job.model_name }}</span>
                        {% endif %}
                    </td>
                    <td class="status-cell">
                        <span class="status-badge status-{{ job.status | lower }}">{{ job.status }}</span>
                        {% if job.error_message %}
                        <div class="error-message">{{ job.error_message }}</div>
                        {% endif %}
                    </td>
                    <td class="progress-cell">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ job.progress }}%"></div>
                        </div>
                        <span class="progress-text">{{ job.progress }}%</span>
                    </td>
                    <td class="actions">
                        {% if job.status in ["WAITING", "PROCESSING"] %}
                        <form action="/jobs/{{ job.id }}/cancel" method="post" style="display:inline;">
                            <button type="submit" class="btn-cancel">Cancel</button>
                        </form>
                        {% elif job.status == "PASSWORD_REQUIRED" %}
                        <button type="button" class="btn-password" onclick="showPasswordModal('{{ job.id }}', '{{ job.error_message | default('') | e }}')">Enter Password</button>
                        {% elif job.status == "COMPLETED" and job.has_excel %}
                        <a href="/jobs/{{ job.id }}/download" class="btn-download">Download</a>
                        {% endif %}
                    </td>
                </tr>
                <tr class="details-row" id="details-{{ job.id }}" style="display: none;">
                    <td colspan="9">
                        <div class="details-container">
                            <div class="details-panel">
                                <h4>Extracted Text</h4>
                                <pre class="details-content" id="extracted-text-{{ job.id }}">{{ job.extracted_text if job.extracted_text else "Not available yet" }}</pre>
                            </div>
                            <div class="details-panel">
                                <h4>LLM Prompt</h4>
                                <pre class="details-content" id="llm-prompt-{{ job.id }}">{{ job.llm_prompt if job.llm_prompt else "Not available yet" }}</pre>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        var jobs = {};
        {% for job in jobs %}
        jobs["{{ job.id }}"] = {
            id: "{{ job.id }}",
            filename: "{{ job.filename }}",
            provider: "{{ job.provider }}",
            model_name: "{{ job.model_name }}",
            status: "{{ job.status }}",
            progress: {{ job.progress }},
            created_at: "{{ job.created_at }}",
            finished_at: {% if job.finished_at %}"{{ job.finished_at }}"{% else %}null{% endif %},
            elapsed_time: "{{ job.elapsed_time }}",
            elapsed_seconds: {{ job.elapsed_seconds }},
            error_message: {% if job.error_message %}"{{ job.error_message }}"{% else %}null{% endif %},
            has_excel: {{ job.has_excel | lower }},
            extracted_text: {% if job.extracted_text %}{{ job.extracted_text | tojson }}{% else %}null{% endif %},
            llm_prompt: {% if job.llm_prompt %}{{ job.llm_prompt | tojson }}{% else %}null{% endif %}
        };
        {% endfor %}

        function switchToMode(mode) {
            var pdfForm = document.getElementById('pdf-form');
            var textForm = document.getElementById('text-form');
            var btnPdf = document.getElementById('btn-pdf-mode');
            var btnText = document.getElementById('btn-text-mode');
            
            if (mode === 'pdf') {
                pdfForm.style.display = 'block';
                textForm.style.display = 'none';
                btnPdf.classList.add('active');
                btnText.classList.remove('active');
            } else {
                pdfForm.style.display = 'none';
                textForm.style.display = 'block';
                btnPdf.classList.remove('active');
                btnText.classList.add('active');
            }
        }

        function toggleDetails(jobId) {
            var detailsRow = document.getElementById('details-' + jobId);
            var chevron = document.getElementById('chevron-' + jobId);
            if (detailsRow.style.display === 'none') {
                detailsRow.style.display = 'table-row';
                chevron.innerHTML = '&#9660;';
            } else {
                detailsRow.style.display = 'none';
                chevron.innerHTML = '&#9654;';
            }
        }

        function showPasswordModal(jobId, errorMessage) {
            document.getElementById('password-job-id').value = jobId;
            document.getElementById('pdf-password').value = '';
            document.getElementById('password-error').style.display = 'none';
            if (errorMessage) {
                document.getElementById('password-modal-message').textContent = errorMessage;
            } else {
                document.getElementById('password-modal-message').textContent = 'This PDF is password-protected. Please enter the password to continue.';
            }
            document.getElementById('password-modal').style.display = 'flex';
            document.getElementById('pdf-password').focus();
        }

        function closePasswordModal() {
            document.getElementById('password-modal').style.display = 'none';
            document.getElementById('password-job-id').value = '';
            document.getElementById('pdf-password').value = '';
            document.getElementById('password-error').style.display = 'none';
        }

        document.getElementById('password-form').addEventListener('submit', function(e) {
            e.preventDefault();
            var jobId = document.getElementById('password-job-id').value;
            var password = document.getElementById('pdf-password').value;
            
            if (!jobId || !password) {
                return;
            }

            var formData = new FormData();
            formData.append('password', password);

            fetch('/jobs/' + jobId + '/password', {
                method: 'POST',
                body: formData
            })
            .then(function(response) {
                if (response.ok) {
                    closePasswordModal();
                } else {
                    return response.json().then(function(data) {
                        document.getElementById('password-error').textContent = data.detail || 'Failed to submit password';
                        document.getElementById('password-error').style.display = 'block';
                    });
                }
            })
            .catch(function(error) {
                document.getElementById('password-error').textContent = 'Network error. Please try again.';
                document.getElementById('password-error').style.display = 'block';
            });
        });

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatElapsedTime(seconds) {
            if (seconds < 60) {
                return seconds + 's';
            } else if (seconds < 3600) {
                var minutes = Math.floor(seconds / 60);
                var secs = seconds % 60;
                return minutes + 'm ' + (secs < 10 ? '0' : '') + secs + 's';
            } else {
                var hours = Math.floor(seconds / 3600);
                var mins = Math.floor((seconds % 3600) / 60);
                return hours + 'h ' + (mins < 10 ? '0' : '') + mins + 'm';
            }
        }

        function updateJobRow(job) {
            var row = document.querySelector('tr[data-job-id="' + job.id + '"]');
            var detailsRow = document.getElementById('details-' + job.id);
            var tbody = document.getElementById('jobs-tbody');
            var container = document.getElementById('queue-container');

            if (!row) {
                row = document.createElement('tr');
                row.setAttribute('data-job-id', job.id);
                row.className = 'job-row';
                
                detailsRow = document.createElement('tr');
                detailsRow.id = 'details-' + job.id;
                detailsRow.className = 'details-row';
                detailsRow.style.display = 'none';
                
                tbody.insertBefore(detailsRow, tbody.firstChild);
                tbody.insertBefore(row, tbody.firstChild);
                container.style.display = '';
            }

            var providerBadge = job.provider === 'offline' 
                ? '<span class="provider-badge offline">' + (job.model_name || 'offline') + '</span>'
                : '<span class="provider-badge online">' + (job.model_name || 'online') + '</span>';

            var statusHtml = '<span class="status-badge status-' + job.status.toLowerCase() + '">' + job.status + '</span>';
            if (job.error_message) {
                statusHtml += '<div class="error-message">' + job.error_message + '</div>';
            }

            var actionsHtml = '';
            if (job.status === 'WAITING' || job.status === 'PROCESSING') {
                actionsHtml = '<form action="/jobs/' + job.id + '/cancel" method="post" style="display:inline;"><button type="submit" class="btn-cancel">Cancel</button></form>';
            } else if (job.status === 'PASSWORD_REQUIRED') {
                actionsHtml = '<button type="button" class="btn-password" onclick="showPasswordModal(\'' + job.id + '\', \'' + escapeHtml(job.error_message || '') + '\')">Enter Password</button>';
            } else if (job.status === 'COMPLETED' && (job.has_excel || job.download_url)) {
                actionsHtml = '<a href="/jobs/' + job.id + '/download" class="btn-download">Download</a>';
            }

            var finishedAtDisplay = job.finished_at ? job.finished_at : '—';
            var elapsedDisplay = job.elapsed_time || formatElapsedTime(job.elapsed_seconds || 0);

            row.innerHTML = 
                '<td class="chevron-cell" onclick="toggleDetails(\'' + job.id + '\')"><span class="chevron" id="chevron-' + job.id + '">&#9654;</span></td>' +
                '<td class="filename">' + job.filename + '</td>' +
                '<td>' + job.created_at + '</td>' +
                '<td>' + finishedAtDisplay + '</td>' +
                '<td class="elapsed-cell" data-elapsed-seconds="' + (job.elapsed_seconds || 0) + '">' + elapsedDisplay + '</td>' +
                '<td>' + providerBadge + '</td>' +
                '<td class="status-cell">' + statusHtml + '</td>' +
                '<td class="progress-cell"><div class="progress-bar"><div class="progress-fill" style="width: ' + job.progress + '%"></div></div><span class="progress-text">' + job.progress + '%</span></td>' +
                '<td class="actions">' + actionsHtml + '</td>';

            var extractedText = job.extracted_text ? escapeHtml(job.extracted_text) : 'Not available yet';
            var llmPrompt = job.llm_prompt ? escapeHtml(job.llm_prompt) : 'Not available yet';
            
            detailsRow.innerHTML = 
                '<td colspan="9">' +
                '<div class="details-container">' +
                '<div class="details-panel"><h4>Extracted Text</h4><pre class="details-content" id="extracted-text-' + job.id + '">' + extractedText + '</pre></div>' +
                '<div class="details-panel"><h4>LLM Prompt</h4><pre class="details-content" id="llm-prompt-' + job.id + '">' + llmPrompt + '</pre></div>' +
                '</div></td>';

            jobs[job.id] = job;
        }

        var eventSource = new EventSource('/events');

        eventSource.addEventListener('job_update', function(e) {
            var job = JSON.parse(e.data);
            updateJobRow(job);
        });

        eventSource.onerror = function(e) {
            console.log('SSE connection error, will reconnect automatically');
        };

        setInterval(function() {
            for (var jobId in jobs) {
                var job = jobs[jobId];
                if (job.status === 'WAITING' || job.status === 'PROCESSING') {
                    job.elapsed_seconds = (job.elapsed_seconds || 0) + 1;
                    var elapsedCell = document.querySelector('tr[data-job-id="' + jobId + '"] .elapsed-cell');
                    if (elapsedCell) {
                        elapsedCell.textContent = formatElapsedTime(job.elapsed_seconds);
                        elapsedCell.setAttribute('data-elapsed-seconds', job.elapsed_seconds);
                    }
                }
            }
        }, 1000);
    </script>
</body>
</html>
